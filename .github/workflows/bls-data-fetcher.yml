name: BLS Data Fetcher (Experimental)

on:
  workflow_dispatch: # Manual trigger only - experimental feature
    inputs:
      occupation_url:
        description: 'BLS OOH URL (e.g., https://www.bls.gov/ooh/math/data-scientists.htm)'
        required: true
        type: string
      role_name:
        description: 'Role name (e.g., Data Scientist, AI/ML Engineer)'
        required: true
        type: string

jobs:
  fetch-bls-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml
        continue-on-error: false

      - name: Fetch BLS data
        id: fetch
        run: |
          python3 << 'PYTHON_SCRIPT'
          import requests
          from bs4 import BeautifulSoup
          import sys
          import os
          
          url = "${{ github.event.inputs.occupation_url }}"
          role_name = "${{ github.event.inputs.role_name }}"
          
          try:
              print(f"Fetching data from: {url}")
              response = requests.get(url, timeout=30)
              response.raise_for_status()
              
              soup = BeautifulSoup(response.content, 'html.parser')
              
              # Try to find median pay
              median_pay = None
              pay_section = soup.find('p', class_='sub-content-type-callout')
              if pay_section:
                  median_pay = pay_section.get_text(strip=True)
              
              # Try to find job outlook / growth projection
              outlook = None
              outlook_section = soup.find('div', class_='ooh-field-outlook')
              if outlook_section:
                  outlook = outlook_section.get_text(strip=True)
              
              # Save results to file
              with open('/tmp/bls_results.txt', 'w') as f:
                  f.write(f"Role: {role_name}\n")
                  f.write(f"URL: {url}\n")
                  f.write(f"Median Pay: {median_pay or 'Not found'}\n")
                  f.write(f"Outlook: {outlook or 'Not found'}\n")
              
              if median_pay or outlook:
                  print(f"Success! Found: Pay={median_pay}, Outlook={outlook}")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"success=true\n")
                      f.write(f"median_pay={median_pay or 'Not found'}\n")
                      f.write(f"outlook={outlook or 'Not found'}\n")
              else:
                  print("Warning: No data extracted. BLS HTML structure may have changed.")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"success=false\n")
                  sys.exit(1)
                  
          except requests.exceptions.Timeout:
              print("Error: Request timed out")
              sys.exit(1)
          except requests.exceptions.RequestException as e:
              print(f"Error fetching URL: {e}")
              sys.exit(1)
          except Exception as e:
              print(f"Unexpected error: {e}")
              sys.exit(1)
          PYTHON_SCRIPT
        continue-on-error: true

      - name: Create issue with BLS data
        if: steps.fetch.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const roleName = '${{ github.event.inputs.role_name }}';
            const url = '${{ github.event.inputs.occupation_url }}';
            
            let results = '';
            try {
              results = fs.readFileSync('/tmp/bls_results.txt', 'utf8');
            } catch (error) {
              results = '(Could not read results file)';
            }
            
            const body = `## ðŸ¤– BLS Data Fetcher Results (Experimental)\n\n` +
              `### Extracted Data:\n\`\`\`\n${results}\n\`\`\`\n\n` +
              `### âš ï¸ Important - Manual Review Required\n` +
              `This is experimental automation. Please verify this data before using:\n\n` +
              `1. **Visit the source:** [${url}](${url})\n` +
              `2. **Compare** the extracted data with what you see on the page\n` +
              `3. **Check context** - BLS often includes notes and caveats\n` +
              `4. **Update manually** if data looks correct\n\n` +
              `### Next Steps:\n` +
              `- [ ] Verify extracted data is accurate\n` +
              `- [ ] Check for any BLS notes or caveats on the page\n` +
              `- [ ] Update ${roleName} role file if data is correct\n` +
              `- [ ] Update README salary table\n` +
              `- [ ] Update "Last Updated" date\n\n` +
              `See [UPDATE_CHECKLIST.md](UPDATE_CHECKLIST.md) for full update process.`;
            
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ¤– BLS Data: ${roleName}`,
                body: body,
                labels: ['maintenance', 'data-update', 'automated', 'needs-review']
              });
            } catch (error) {
              console.error('Failed to create issue:', error);
              core.setFailed(`Issue creation failed: ${error.message}`);
            }

      - name: Notify on scraping failure
        if: steps.fetch.outputs.success != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const roleName = '${{ github.event.inputs.role_name }}';
            const url = '${{ github.event.inputs.occupation_url }}';
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ BLS Data Fetch Failed: ${roleName}`,
              body: `BLS data extraction failed for **${roleName}**.\n\n` +
                `**URL:** ${url}\n\n` +
                `### Likely Reasons:\n` +
                `- BLS changed their HTML structure (happens frequently)\n` +
                `- Network timeout or connection issue\n` +
                `- Invalid URL provided\n\n` +
                `### Resolution:\n` +
                `Please update **${roleName}** manually:\n` +
                `1. Visit [${url}](${url})\n` +
                `2. Copy median pay and job outlook data\n` +
                `3. Update role file and README\n` +
                `4. See [UPDATE_CHECKLIST.md](UPDATE_CHECKLIST.md)\n\n` +
                `[View workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['maintenance', 'workflow-failure', 'needs-manual-update']
            });
